<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

	<head>
		<title>文本框</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<link rel="stylesheet" href="bootstrap/css/bootstrap.css">
		<!--[if lte IE 6]>
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap-ie6.css">
    <![endif]-->
		<!--[if lte IE 7]>
    <link rel="stylesheet" type="text/css" href="bootstrap/css/ie.css">
    <![endif]-->
		<link rel="stylesheet" href="leipi.style.css">
		<script type="text/javascript" src="../dialogs/internal.js"></script>
		<script type="text/javascript" src="jquery-3.2.1.min.js"></script>
		<script src="self/js/py.js"></script>
		<script type="text/javascript" src="../httpData.config.js"></script>

		<script type="text/javascript">
			/* Thank you by
                                    http://www.alt-tag.com/blog/2006/02/ie-dom-bugs/ */

			function createElement(type, name) {
				var element = null;
				try {
					element = document.createElement('<' + type + ' name="' + name + '">');
				} catch (e) {}
				if (element == null) {
					element = document.createElement(type);
					element.name = name;
				}
				return element;
			}
		</script>

	</head>

	<body>
		<div class="content">
			<table class="table table-bordered table-striped table-hover">
				<tr>
					<th>
						<span>控件名称</span>
						<span class="label label-important">*</span>
						<span>字段拼音</span>
					</th>
					<th>
						<span>提示内容</span>
						<span class="label label-important">*</span>
					</th>
				</tr>
				<tr>
					<td>
						<input type="text" class="span2" id="orgname" onclick="javascript:this.select()" placeholder="必填项" value="文本框"
						 onblur="getPY(this.value)">
						<input type="text" class="span2" id="pluName" placeholder="只允许拼音、不允许有相同名" value="">
					</td>
					<td>
						<input type="text" id="orgvalue">
					</td>
				</tr>
				<tr>
					<th>
						<span>数据源</span>
					</th>
					<th>
						<span>数据字段</span>
					</th>
				</tr>
				<tr>
					<td>
						<select id="datasource">
							<option value="0">请选择</option>

						</select>
					</td>
					<td>
						<select id="datazid">
							<option value="0">请选择</option>

						</select>
					</td>
				</tr>
				<tr>
					<th>
						<span>数据类型</span>
					</th>
					<th>
						<span>对齐方式</span>
					</th>
				</tr>
				<tr>
					<td>
						<select id="orgtype" onchange="checkType(event)">
							<option value="text">普通文本</option>
							<option value="email">邮箱地址</option>
							<option value="int">整数</option>
							<option value="float">小数</option>
							<option value="idcard">身份证号码</option>
						</select>
					</td>
					<td>
						<select id="orgalign">
							<option value="left">左对齐</option>
							<option value="center">居中对齐</option>
							<option value="right">右对齐</option>
						</select>
					</td>
				</tr>
				<tr>
					<th>
						<span>显示个数控制</span>
					</th>
					<th>
						<span>字体设置</span>
					</th>
				</tr>
				<tr>
					<td>
						<!--  -->
						<span><input id="orgprintlength" type="number" value="" min="0" placeholder="auto"></span>
					</td>
					<td>
						<select id="fontset" name="fontset">
							<option value="默认">默认</option>
							<option value="SimSun">宋体</option>
							<option value="SimHei">黑体</option>
							<option value="Microsoft YaHei">微软雅黑</option>
							<option value="KaiTi">楷体</option>
							<option value="LiSu">隶书</option>
						</select>
					</td>
				</tr>
				<tr>
					<th colspan="2">
						<span>输入框样式</span>
					</th>
				</tr>
				<tr>
					<td colspan="2">
						宽:
						<input id="orgwidth" type="text" class="input-small span1" placeholder="auto" value="" onclick="this.value=this.value.replace(/\D/g,'')"
						 onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" />
						<select id="orgvarfontwidth" style="width:65px;">
							<option>PX</option>
							<option>%</option>
						</select>
						&nbsp;&nbsp; 高:
						<input id="orgheight" type="text" class="input-small span1" placeholder="auto" value="" onclick="this.value=this.value.replace(/\D/g,'')"
						 onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" />
						<select id="orgvarfontheight" style="width:65px;">
							<option>PX</option>
							<option>%</option>
						</select>
						&nbsp;&nbsp;字体大小
						<input id="orgfontsize" type="text" value="16" class="input-small span1" placeholder="auto" />
						<select id="orgvarfontsize" style="width:75px;">
							<option>PX</option>
						</select>
					</td>
				</tr>
				<tr>
					<th>
						<span>限制在一个块元素显示的文本的行数</span>
					</th>
					<th>
						<span>输入限制文本的字数</span>
					</th>
				</tr>
				<tr>
					<td>
						<input type="number" id="lineClamp" value="1">
					</td>
					<td>
						<input type="number" id="maxLength" value="">
					</td>
				</tr>
				<tr>
					<th colspan="2">
						<span>隐藏</span>
					</th>
				</tr>
				<tr>
					<td colspan="2">
						<label class="checkbox inline">
							<input id="orghide" type="checkbox" /> 可见性 </label>
						<label class="checkbox inline">
							<input id="orgthide" type="checkbox" /> 边框 </label>
						<label class="checkbox inline">
							<input id="orgbghide" type="checkbox" /> 底色 </label>
						<label class="checkbox inline">
							<input id="orgdisabled" type="checkbox" /> 是否禁用</label>
					</td>
				</tr>
				<tr>
					<th colspan="2">
						<span>特殊功能</span>
					</th>
				</tr>
				<tr>
					<td colspan="2">
						<label class="checkbox inline">
							<input id="writeNickname" type="checkbox" /> 写入操作用户 </label>
					</td>
				</tr>
			</table>
		</div>
		<script>
			//读取cookie
			var cookieStr = unescape(document.cookie);
			var arr = cookieStr.split("|");
			var cookieWidth = "";
			var cookieHeight = "";
			if (cookieStr != "") {
				for (var i = 0; i < arr.length; i++) {
					var temp = arr[i].split("=");
					if (temp[0] == "width") {
						// debugger;
						cookieWidth = temp[1];
						$("#orgvarfontwidth").val(cookieWidth);
					} else if (temp[0] == "height") {
						cookieHeight = temp[1];
						$("#orgvarfontheight").val(cookieHeight);
					}
				}
			}
			var gVarfontwidth = $("#orgvarfontwidth").val();
			$("#orgvarfontwidth").change(function() {
				gVarfontwidth = $("#orgvarfontwidth").val();
				var height = "";
				var str = unescape(document.cookie);
				//存在height
				if (str.indexOf("height") != -1) {
					var arr = str.split("|");
					for (var i = 0; i < arr.length; i++) {
						var temp = arr[i].split("=");
						if (temp[0] == "height") {
							height = temp[1];
						}
					}
				} else { //不存在就清空
					document.cookie = "";
				}
				//保存cookie
				if (height != "") {
					document.cookie = "width=" + gVarfontwidth + "|" + "height=" + height + "|";
				} else {
					document.cookie = "width=" + gVarfontwidth + "|";
				}
			});
			var gVarfontheight = $("#orgvarfontheight").val();
			$("#orgvarfontheight").change(function() {
				gVarfontheight = $("#orgvarfontheight").val();
				var width = "";
				var str = unescape(document.cookie);
				//存在height
				if (str.indexOf("width") != -1) {
					var arr = str.split("|");
					for (var i = 0; i < arr.length; i++) {
						var temp = arr[i].split("=");
						if (temp[0] == "width") {
							width = temp[1];
						}
					}
				} else { //不存在就清空
					document.cookie = "";
					width = $("#orgvarfontwidth").val();
				}
				document.cookie = "width=" + width + "|" + "height=" + gVarfontheight + "|";
			});
		</script>

		<script type="text/javascript">
			var oNode = null,
				gdataSource = null,
				control_name = null,
				nodeId = null;
			//gdataid,
			//gdataField,
			thePlugins = 'text';
			window.onload = function() {
				$G('orgname').select();
				if (UE.plugins[thePlugins].editdom) {
					oNode = UE.plugins[thePlugins].editdom;
					var gValue = '';
					if (oNode.getAttribute('value'));
					//orgvarfontwidth orgheight
					var gValue = oNode.getAttribute('value').replace(/&quot;/g, "\""),
						gTitle = oNode.getAttribute('title').replace(/&quot;/g, "\""),
						gHidden = oNode.getAttribute('orghide'),
						gFontSize = oNode.getAttribute('orgfontsize'),
						gAlign = oNode.getAttribute('orgalign'),
						gWidth = oNode.getAttribute('orgwidth'),
						gHeight = oNode.getAttribute('orgheight'),
						gPrintLength = oNode.getAttribute('orgprintlength'),
						gType = oNode.getAttribute('orgtype'),
						name = oNode.getAttribute('name'),
						fontset = oNode.getAttribute('fontset'),
						gThidden = oNode.getAttribute('orgthide');
					//gMLenght=oNode.getAttribute('orgmaxlenght');
					control_name = name;
					gBghidden = oNode.getAttribute('orgbghide');
					gdisable = oNode.getAttribute('orgdisabled');
					gBghidden = oNode.getAttribute('orgbghide');
					glineClamp = oNode.getAttribute('lineClamp');
					gwriteNickname = oNode.getAttribute('writenickname');
					//gmaxLength = oNode.getAttribute( 'maxLength' );
					//gdataid = oNode.getAttribute( 'dataid' );
					//gdataField = oNode.getAttribute( 'datafield' );
					gValue = gValue == null ? '' : gValue;
					gTitle = gTitle == null ? '' : gTitle;

					$G('orgvalue').setAttribute('value', gValue);
					$G('orgname').value = gTitle;
					//  $("#datasource option[value="+1004+"]").prop('selected','selected');
					if (gHidden == '1') $G('orghide').checked = true;
					if (gThidden == '1') $G('orgthide').checked = true;
					if (gBghidden == '1') $G('orgbghide').checked = true;
					if (gdisable == '1') $G('orgdisabled').checked = true;
					if (gwriteNickname == '1') $G('writeNickname').checked = true;
					if (fontset != "null") $("option[value='" + fontset + "']").prop('selected', true);
					$G('orgfontsize').value = gFontSize;
					$G('orgvarfontheight').value = gVarfontheight;
					$G('orgwidth').value = parseInt(gWidth);
					$G('orgheight').value = parseInt(gHeight);
					$G('orgprintlength').value = gPrintLength;
					$G('orgalign').value = gAlign;
					$G('orgtype').value = gType;
					$G('pluName').value = name;
					//$G( 'orgmaxlenght' ).value = parseInt(gMLenght);

					$G('orgthide').value = gThidden;
					$G('orgbghide').value = gBghidden;

					$G('lineClamp').value = glineClamp;
					//$G( 'maxLength' ).value = gmaxLength;

				}

				/*
				 * 链接后台获取 数据链接
				 *
				 */

				var nodeParentId = $('#nodeParentId', window.parent.document).val();
				nodeId = $('#node_id', window.parent.document).val();
				var userinfo = window.localStorage['user'] ? JSON.parse(window.localStorage['user']) : null;


				var datasource = window.localStorage['datasource_' + userinfo.id] ? window.localStorage['datasource_' + userinfo.id] :
					null;
				if (datasource == null) {
					$.ajax({
						url: prevent_HOST + 'nodeQueryFacade/getDataSourcePage?nodeId=' + nodeId + "&uid=" + userinfo.id,
						method: 'GET',
						success: function(res) {
							$.each(res.msg, function(index, value) {
								$("#datasource").append('<option value=' + value.id + '>' + value.value + '</option>');
							})

							//$('#datasource').find('option[value='+gdataid+']').attr('selected','true');

						},
						error: function(res) {
							alert('抱歉！获取 数据链接 失败！因为您好像还没有选择表哦！')
						}
					});
				} else {
					$("#datasource").append(datasource);
				}
				$(document).on("change", "#datasource", function(e) {
					var nodeParentId = $(this).val().split(":");
					$("#datazid").empty();
					$.ajax({
						url: prevent_HOST + 'pageDesignQueryFacade/getPageEditorData?id=' + nodeParentId[0],
						method: "GET",
						success: function(res) {
							// console.log('get')
							$.each(res.msg, function(index, value) {
								$("#datazid").append('<option value=' + value.value + '>' + value.text + '</option>');
							})
							// $('#datazid').find('option[value='+gdataField+']').attr('selected','true');
						}
					})
				});
			}

			dialog.oncancel = function() {
				if (UE.plugins[thePlugins].editdom) {
					delete UE.plugins[thePlugins].editdom;
				}
			};
			dialog.onok = function() {
				if ($G('orgname').value == '') {
					alert('请输入控件名称');
					return false;
				}
				var PN = $('#pluName');
				cupy = PN.val();

				if (cupy == '') {
					getPY($G('orgname').value);
				}
				//输入框的值做显示控制判断
				var text_length, //文本框长度
					print_length, //控制的显示长度
					gValue, //文本框的数据
					temp_Value; //文本框的临时数据
				temp_Value = $G('orgvalue').value.replace(/\"/g, "&quot;"); //保存文本框的值
				gPrintLength = $G('orgprintlength').value;
				text_length = temp_Value.length;
				print_length = gPrintLength;
				var fontset = $("#fontset").val();
				if (print_length == "" || print_length == 0) //不做限制的时候
				{
					gValue = temp_Value;
				} else if (text_length > print_length) { //大于
					var html = "";
					for (var i = 0; i < print_length; i++) {
						html += temp_Value[i];
					}
					html += '...';
					gValue = html;
				} else if (text_length <= print_length) { //输入长度小于限制长度
					gValue = temp_Value;
				}
				var gTitle = $G('orgname').value.replace(/\"/g, "&quot;"),
					gFontSize = $G('orgfontsize').value,
					gAlign = $G('orgalign').value,
					gWidth = $G('orgwidth').value,
					gHeight = $G('orgheight').value,
					gType = $G('orgtype').value,
					gds = $G('datasource').value,
					//gMLenght=$G('orgmaxlenght').value,
					glineClamp = $G('lineClamp').value,
					//gmaxLength = $G( 'maxLength' ).value,
					datasource;
				if ($G('datasource').value == 0) {
					var gdataS = "",
						dataId = 0
				} else {
					gdataS = $("#datasource option:selected").text();
					dataId = $("#datasource option:selected").val();
				}
				if ($G('datazid').value == 0) {
					var gdataId = "";
					// dataField = 0;
				} else {
					gdataId = $G('datazid').value;
					//dataField = $("#datazid option:selected").val();
				}
				datasource = '{\"data\":\"' + gdataS + '\",\"field\":\"' + gdataId + '\"}';
				if (!oNode) {
					try {
						if (cupy == '') cupy = 'leipiNewField';
						oNode = createElement('input', cupy);
						oNode.setAttribute('type', 'text');
						oNode.setAttribute('title', gTitle);
						oNode.setAttribute('value', gValue);
						oNode.setAttribute('fontset', fontset);
						//oNode.setAttribute( 'maxlenght', orgmaxlenght);
						// oNode.setAttribute( 'name', 'leipiNewField' );
						oNode.setAttribute("datasource", datasource);
						oNode.setAttribute('leipiPlugins', thePlugins);

						if ($G('writeNickname').checked) {
							oNode.setAttribute('writeNickname', 1);
						} else {
							oNode.setAttribute('writeNickname', 0);
						}

						//oNode.setAttribute( 'maxlength',gmaxLength );
						////oNode.setAttribute( 'dataid' ,dataId);
						// oNode.setAttribute( 'datafield',dataField);
						if (print_length != "" && print_length != 0) {
							oNode.setAttribute('value_2', temp_Value);
						}
						$G('orghide').checked ? oNode.setAttribute('orghide', 1) : oNode.setAttribute('orghide', 0);

						// orgwidth
						// orgwidth.indexOf('PX','%');
						//  overflow:hidden;text-overflow: ellipsis;white-space: nowrap;
						if ($G('orgdisabled').checked) {
							oNode.style.overflow = 'hidden';
							oNode.style.textOverflow = 'ellipsis';
							oNode.style.whiteSpace = 'nowrap';
							oNode.setAttribute('orgthide', 1);
						} else {
							oNode.setAttribute('orgthide', 0);
							oNode.style.overflow = '';
							oNode.style.textOverflow = '';
							oNode.style.whiteSpace = '';
						}
						if ($G('orgthide').checked) {
							oNode.style.border = 'none';
							oNode.setAttribute('orgthide', 1);

						} else {

							oNode.setAttribute('orgthide', 0);
							oNode.style.border = '';
						}
						if ($G('orgdisabled').checked) {
							oNode.setAttribute('orgdisabled', 1);
							oNode.setAttribute('disabled', "disabled");
						} else {
							oNode.setAttribute('orgdisabled', 0);
							oNode.removeAttribute('disabled');
						}

						if ($G('orgbghide').checked) {

							oNode.setAttribute('orgbghide', 1);
							oNode.style.background = 'none';
						} else {

							oNode.setAttribute('orgbghide', 0);
							oNode.style.background = '';
						}

						if (gFontSize != '') {
							oNode.style.fontSize = gFontSize + 'px';
							oNode.setAttribute('orgfontsize', gFontSize);
						}
						if (gAlign != '') {
							//style += 'text-align:' + gAlign + ';';
							oNode.style.textAlign = gAlign;
							oNode.setAttribute('orgalign', gAlign);
						}
						if (gWidth != '') {
							if (gVarfontwidth == 'PX') {
								oNode.style.width = gWidth + 'px';
								//style += 'width:' + gWidth + 'px;';
								oNode.setAttribute('orgwidth', gWidth + 'px');
							}
							if (gVarfontwidth == '%') {
								oNode.style.width = gWidth + '%';
								//style += 'width:' + gWidth + '%;';
								oNode.setAttribute('orgwidth', gWidth + '%');
							}
						}
						if (gHeight != '') {
							if (gVarfontheight == 'PX') {
								oNode.style.height = gHeight + 'px';
								//style += 'height:' + gHeight + 'px;';
								oNode.setAttribute('orgheight', gHeight + 'px');
							}
							if (gVarfontheight == '%') {
								oNode.style.height = gHeight + '%';
								//style += 'height:' + gHeight + 'px;';
								oNode.setAttribute('orgheight', gHeight + '%');
							}
						}
						if (gPrintLength != '') {
							oNode.setAttribute('orgprintlength', gPrintLength);

						} else {
							oNode.setAttribute('orgprintlength', 0);
						}
						if (gType != '') {
							oNode.setAttribute('orgtype', gType);
						} else {
							oNode.setAttribute('orgtype', "");
						}
						if (glineClamp != '') {
							oNode.style.lineClamp = glineClamp;
							oNode.setAttribute('lineClamp', glineClamp);
						} else {
							oNode.style.lineClamp = "";
							oNode.setAttribute('lineClamp', "");
						}






						oNode.style.overflow = "hidden";
						oNode.style.textOverflow = "ellipsis";
						oNode.style.boxOrient = "vertical";
						//console.log( oNode.outerHTML , oNode );

						editor.execCommand('insertHtml', oNode.outerHTML);
						var editNewData = {
							"node_id": nodeId,
							"title": gTitle,
							"control_name": cupy
						}
						$.ajax({
							url: prevent_HOST + `pageDesignOperatorFacade/insertControl`,
							type: 'POST',
							dataType: 'json',
							contentType: 'application/json; charset=UTF-8',
							data: JSON.stringify(editNewData),
							async: false,
							success: function(res) {}
						})
					} catch (e) {
						try {
							editor.execCommand('error');
						} catch (e) {
							alert('控件异常，请反馈或寻求帮助！');
						}
						return false;
					}
				} else {
					oNode.setAttribute('title', gTitle);
					oNode.setAttribute('name', cupy);
					oNode.setAttribute('value', $G('orgvalue').value);
					oNode.setAttribute("datasource", datasource);
					oNode.setAttribute('fontset', fontset);
					if ($G('writeNickname').checked) {
						oNode.setAttribute('writeNickname', 1);
					} else {
						oNode.setAttribute('writeNickname', 0);
					}
					$G('orghide').checked ? oNode.setAttribute('orghide', 1) : oNode.setAttribute('orghide', 0);
					if ($G('orgthide').checked) {
						oNode.setAttribute('orgthide', 1);
						oNode.style.border = 'none';
					} else {
						oNode.setAttribute('orgthide', 0);
						oNode.style.border = "";
					}
					if ($G('orgbghide').checked) {
						oNode.setAttribute('orgbghide', 1);
						oNode.style.background = 'none';
					} else {
						oNode.setAttribute('orgbghide', 0);
						oNode.style.background = "";
					}
					if ($G('orgdisabled').checked) {
						oNode.setAttribute("disabled", "disabled")
						oNode.setAttribute("orgdisabled", 1);
					} else {
						oNode.setAttribute("orgdisabled", 0);
						oNode.removeAttribute("disabled");
					}
					// if($G('#datasource' != '')){
					//    oNode.setAttribute( 'dataid',dataId);
					// }else{
					//     oNode.setAttribute( 'datafield',dataId )
					// }

					if (gFontSize != '') {
						oNode.style.fontSize = gFontSize + 'px';
						oNode.setAttribute('orgfontsize', gFontSize);
					} else {
						oNode.style.fontSize = '';
						oNode.setAttribute('orgfontsize', '');
					}
					if (gAlign != '') {
						oNode.style.textAlign = gAlign;
						oNode.setAttribute('orgalign', gAlign);
					} else {
						oNode.setAttribute('orgalign', '');
					}
					if (gWidth != '') {
						if (gVarfontwidth == "PX") {
							oNode.style.width = gWidth + 'px';
							oNode.setAttribute('orgwidth', gWidth + 'px');
						}
						if (gVarfontwidth == "%") {
							oNode.style.width = gWidth + '%';
							oNode.setAttribute('orgwidth', gWidth + '%');
						}
					} else {
						oNode.style.width = '';
						oNode.setAttribute('orgwidth', '');
					}
					if (gHeight != '') {
						if (gVarfontheight == "PX") {
							oNode.style.height = gHeight + 'px';
							oNode.setAttribute('orgheight', gHeight + 'px');
						}
						if (gVarfontheight == "%") {
							oNode.style.height = gHeight + '%';
							oNode.setAttribute('orgheight', gHeight + '%');
						}
					} else {
						oNode.style.height = '';
						oNode.setAttribute('orgheight', '');
					}
					if (gPrintLength != '') {
						oNode.setAttribute('orgprintlength', gPrintLength);

					} else {
						oNode.setAttribute('orgprintlength', 0);
					}
					if (gType != '') {
						oNode.setAttribute('orgtype', gType);
					} else {
						oNode.setAttribute('orgtype', '');
					}
					if (glineClamp != '') {
						oNode.style.lineClamp = glineClamp;
						oNode.setAttribute('lineClamp', glineClamp);
					} else {
						oNode.style.lineClamp = "";
						oNode.setAttribute('lineClamp', "");
					}



					oNode.style.overflow = "hidden";
					oNode.style.textOverflow = "ellipsis";
					oNode.style.boxOrient = "vertical";
					delete UE.plugins[thePlugins].editdom;

					var editNewData = {
						"node_id": nodeId,
						"title": gTitle,
						"control_name": control_name,
						"new_control_name": cupy
					}
					$.ajax({
						url: prevent_HOST + `pageDesignOperatorFacade/updateControl`,
						type: 'POST',
						dataType: 'json',
						contentType: 'application/json; charset=UTF-8',
						data: JSON.stringify(editNewData),
						async: false,
						success: function(res) {}
					})
				}
			};
		</script>
	</body>

</html>
